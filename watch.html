<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="Styles/watch.css" />
    <title>Watch</title>
</head>
<body id="body">
  
  
  <script src="https://cdn.jsdelivr.net/npm/webtorrent@latest/webtorrent.min.js"></script>

  <!-- The core Firebase JS SDK is always required and must be listed first -->
  <script src="https://www.gstatic.com/firebasejs/7.21.1/firebase-app.js"></script>

  <!-- TODO: Add SDKs for Firebase products that you want to use
       https://firebase.google.com/docs/web/setup#available-libraries -->
  <script src="https://www.gstatic.com/firebasejs/7.21.1/firebase-firestore.js"></script>     
  <script src="https://www.gstatic.com/firebasejs/7.21.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.21.1/firebase-storage.js"></script>

  <script>

  //#region firebase config
  var firebaseConfig = {
    apiKey: "AIzaSyAcLB4KXLJuY0h0frapGOiTYozINTgwHxE",
    authDomain: "movies-2497b.firebaseapp.com",
    databaseURL: "https://movies-2497b.firebaseio.com",
    projectId: "movies-2497b",
    storageBucket: "movies-2497b.appspot.com",
    messagingSenderId: "777577045829",
    appId: "1:777577045829:web:1b8fd94c35bba31254a82c"
  };
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);

  var db = firebase.firestore();
  var auth = firebase.auth();
  var storage = firebase.storage();
  //#endregion

    const currentUrl = new URL(window.location.href);
    const queryObject = currentUrl.searchParams
    const body = document.getElementById("body");
    let player;

    const movieID = queryObject.get("movieID");

    if(!movieID) 
    {
        window.location.href = "/movie-link-hosting-site/index.html"
    }

    getMovieInfo();

    function getMovieInfo() 
    {
        let collection = db.collection("Movies");
        let doc = collection.doc(movieID.toString());

        doc.get()
        .then(doc => 
        {
           if(!doc.exists) 
           {
               window.location.href = "/movie-link-hosting-site/index.html";
               return;
           }
           
           renderMovie(doc.data())


        })
        .catch(error => console.log(error))

    }

    function renderMovie(movieInfo) 
    {
      let client = new WebTorrent();
      let magnet ="magnet:?xt=urn:btih:08ada5a7a6183aae1e09d831df6748d566095a10&dn=Sintel&tr=udp%3A%2F%2Fexplodie.org%3A6969&tr=udp%3A%2F%2Ftracker.coppersurfer.tk%3A6969&tr=udp%3A%2F%2Ftracker.empire-js.us%3A1337&tr=udp%3A%2F%2Ftracker.leechers-paradise.org%3A6969&tr=udp%3A%2F%2Ftracker.opentrackr.org%3A1337&tr=wss%3A%2F%2Ftracker.btorrent.xyz&tr=wss%3A%2F%2Ftracker.fastcast.nz&tr=wss%3A%2F%2Ftracker.openwebtorrent.com&ws=https%3A%2F%2Fwebtorrent.io%2Ftorrents%2F&xs=https%3A%2F%2Fwebtorrent.io%2Ftorrents%2Fsintel.torrent";

      client.add(magnet, function (torrent) 
     {
      var file = torrent.files.find(function (file) {
       return file.name.endsWith('.mp4')
     })

  // Display the file by adding it to the DOM. Supports video, audio, image, etc. files
      file.appendTo('body')
      
     })

     console.log(client.progress);
    }

    function renderMovieOLD(movieInfo) 
    {
      
      let h1 = document.createElement("h1");
      let video = document.createElement("video");
      let source = document.createElement("source");
      let track = document.createElement("track");

      h1.innerText = movieInfo.Name;
    
      video.controls = true;
      video.poster = movieInfo.PosterPath;
      video.playsInline = true;
    
      source.src = movieInfo.Path;

      track.src = `Subtitles/${movieInfo.SubtitlePath}`;
      track.kind = "subtitles";
      track.label = "English";

      video.appendChild(source);
      video.appendChild(track)
      video.id = "plyr";
      
      body.appendChild(h1);
      body.appendChild(video)

      player = new Plyr(document.getElementById('plyr'));
    }
    

  </script>

</body>
</html>